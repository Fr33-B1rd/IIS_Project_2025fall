import time
import cv2
import os
import torch
from perception import EmotionDetector

def test_vision_pipeline():
    print("\n--- PERCEPTION MODULE TEST SCRIPT ---")
    
    # 1. Verification Checks
    if not os.path.exists("models/emotion_classifier.pth"):
        print("!! WARNING: 'models/emotion_classifier.pth' not found.")
        print("!! Predictions will be random (Dummy Mode).")
    
    if not torch.cuda.is_available():
        print("!! WARNING: CUDA (GPU) is not available. System might be slow.")
    else:
        print(f"OK: Running on GPU: {torch.cuda.get_device_name(0)}")

    # 2. Initialize
    print("\nInitializing DINOv2 + Classifier... (This may take a few seconds)")
    try:
        eyes = EmotionDetector(model_path="models/emotion_classifier.pth")
    except Exception as e:
        print(f"\nCRITICAL ERROR: Could not start EmotionDetector.\nDetails: {e}")
        return

    print("SUCCESS: System initialized.")
    
    # 3. RUN CALIBRATION (Crucial for fixing the "Always Nervous" bug)
    print("-" * 50)
    eyes.calibrate()
    print("-" * 50)
    
    print("Press 'q' in the video window or Ctrl+C here to stop.")

    # 4. Performance Loop
    frame_cnt = 0
    start_time = time.time()
    
    try:
        while True:
            loop_start = time.time()
            
            # --- CALL THE PERCEPTION MODULE ---
            # This now handles the cv2.imshow with the "Debug Overlay" internally
            emotion = eyes.get_emotion()
            # ----------------------------------
            
            # FPS Calculation (Running Average)
            frame_cnt += 1
            elapsed_total = time.time() - start_time
            avg_fps = frame_cnt / elapsed_total
            
            # Instant Latency
            latency_ms = (time.time() - loop_start) * 1000

            # Console Output (Shows what the Python logic sees)
            print(f"\r[Detected: {emotion: <10}] | Avg FPS: {avg_fps:.1f} | Latency: {latency_ms:.1f}ms", end="")

            # Exit condition
            if cv2.waitKey(1) & 0xFF == ord('q'):
                print("\nQuitting...")
                break

    except KeyboardInterrupt:
        print("\nStopped by user.")
    
    finally:
        if hasattr(eyes, 'cap') and eyes.cap.isOpened():
            eyes.cap.release()
        cv2.destroyAllWindows()
        print("\nTest Complete.")

if __name__ == "__main__":
    test_vision_pipeline()